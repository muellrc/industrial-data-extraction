version: "3.9"
services:

  dev-grafana:
        image: grafana/grafana
        restart: always
        ports:
          - "8080:3000"
        depends_on:
          - influxdb
        volumes:
          - grafana-storage:/var/lib/grafana
        build:
          context: ./grafana
    
  hivemq:
    image: hivemq/hivemq-ce
    restart: always
    ports:
      - "1883:1883"
    networks:
      - industrial-data-extraction-network

  data-extractor:
    build: industrialdataextraction
    platform: linux/amd64
    restart: always
    ports:
      - "8081:1883"
    depends_on:
      - hivemq
      - modbus-server
    networks:
      - industrial-data-extraction-network
           
  modbus-server:
    build: modbus-server
    ports:
      - 502:502
    restart: on-failure
    networks:
      - industrial-data-extraction-network
    volumes:
      - extractor-storage:/var/lib/extractor

  modbus-client:
    build: modbus-client
    restart: on-failure
    depends_on:
      - modbus-server
    networks:
      - industrial-data-extraction-network  


networks:
  industrial-data-extraction-network:

volumes:
 influxdb-storage:
 grafana-storage:
 extractor-storage:



  # ========================OLD========================
  # influxdb:
  #   image: influxdb
  #   restart: always
  #   ports:
  #     - "8086:8086"
  #   environment:
  #     - INFLUXDB_DB=telegraf
  #     - INFLUXDB_USER=telegraf
  #     - INFLUXDB_ADMIN_ENABLED=true
  #     - INFLUXDB_ADMIN_USER=admin
  #     - INFLUXDB_ADMIN_PASSWORD=Welcome1 
  #   networks:
  #       - industrial-data-extraction-network
  #   volumes:
  #       - influxdb-storage:/var/lib/influxdb

  # telegraf:
  #   image: telegraf
  #   container_name: telegraf
  #   restart: always
  #   volumes:
  #    - ./telegraf.conf:/etc/telegraf/telegraf.conf:ro
  #   depends_on:
  #     - influxdb
  #   links:
  #     - influxdb
  #   ports:
  #   - '8125:8125'
  #   networks:
  #     - industrial-data-extraction-network
  #   environment:                            
  #     INFLUXDB_URL: http://influxdb:8086 